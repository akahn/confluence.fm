<!DOCTYPE>
<html>
  <head>
    <title>Social Jams</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>
    <script src="https://raw.github.com/cowboy/jquery-bbq/master/jquery.ba-bbq.min.js"></script>
    <script src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
    <script src="/jquery.mustache.js"></script>
    <script id="song-row" type="text/mustache">
      {{#data}}
        <tr data-url={{source}}>
          <td>{{from.name}}</td>
          <td>{{name}}</td>
          <td><a class=remove href=javascript:>X</a></td>
        </tr>
      {{/data}}
    </script>
    <script>
      window.fbAsyncInit = function() {
        FB.init({
          appId      : '309724822372094',
          status     : true, // check login status
          cookie     : true, // enable cookies to allow the server to access the session
          oauth      : true, // enable OAuth 2.0
        });
      };

      $(document).ready(function() {
        $('#fetch-stream').click(function() {
          if (FB.getAuthResponse) {
            loadFeed();
          }
          else {
            FB.login(function(response) {
              if (response.authResponse) {
                loadFeed();
              }
            }, {scope: 'read_stream'});
          }
        });

        $('.remove').live('click', function(e) {
          $(this).closest('tr').remove();
        });

        $('#play').click(function() {
          var ids = extractVideoIds();
          embedVideo(ids);

          $(this).hide();
        });
      });

      function extractVideoIds() {
        var urls = [];

        $('tbody tr').each(function(i, elem) {
          urls.push($(elem).attr('data-url'));
        });

        return _.map(urls, function(url) {
          return url.match(/v\/(.+)\?/)[1];
        });
      }

      function loadFeed() {
        FB.api('/me/home', {limit: 200}, function(response) {
          if (response.data) {
            renderList(response);
          }
          else {
            alert(response.error.message);
          }
        });
      }

      function selectVideoItems(response) {
        var list = _.filter(response.data, function(item) {
          return item.type == 'video' && item.source.match('youtu\.?be')
        })

        return {data: list.reverse()};
      }

      function renderList(response) {
        var template = $('#song-row').html(),
            response = selectVideoItems(response);

        $('#fetch-stream').hide();
        $('#play').show();
        $('table').show().find('tbody').append($.mustache(template, response))
      }

      function embedVideo(ids) {
        var firstId = ids.shift();
        swfobject.embedSWF("http://www.youtube.com/v/" + firstId + "?enablejsapi=1&playerapiid=video&autoplay=1&playlist=" + ids.join(',') + '&playnext=1&version=3', "video", "825", "356", "8", null, null, null, null);
      }

      // Load the YouTube JS asynchronously
      var tag = document.createElement('script');
      tag.src = "http://www.youtube.com/player_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // Load the Facebook JS asynchronously
      (function(d){
         var js, id = 'facebook-jssdk'; if (d.getElementById(id)) {return;}
         js = d.createElement('script'); js.id = id; js.async = true;
         js.src = "//connect.facebook.net/en_US/all.js";
         d.getElementsByTagName('head')[0].appendChild(js);
       }(document));

      $('a').click(function() {
        FB.api('/me', function(response) {
          alert('Your name is ' + response.name);
        });
      });
    </script>
  </head>
<body>
  <div id="fb-root"></div>
  <h1>Social Jams</h1>
  <h2>Make a playlist out of the music your friends are sharing</h2>
  <a id="fetch-stream" href="javascript:">Load music</a>
  <a id="play" href="javascript:" style="display:none">Play</a>
  <div id="video">
  </div>
  <table style="display:none">
    <thead><tr><td>From</td><td>Video</td></tr></thead>
    <tbody>
    </tbody>
  </table>
</body>
</html>
